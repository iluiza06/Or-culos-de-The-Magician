<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin ‚Ä¢ Or√°culos de The Magician</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Inter:wght@500;700;800&family=Great+Vibes&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="admin.css">
</head>

<body>
  <div id="app" class="center">
    <!-- Login -->
    <div class="card login" id="login-card">
      <div class="topbar">
        <a class="brand" id="brandHomeDash" href="index.html">
          <div class="sig"></div>
          <div class="name">Or√°culos de The Magician</div>
        </a>
      </div>

      <h1>Acesso restrito</h1>
      <p class="muted">Entre com seu e-mail e senha do Firebase (Authentication).</p>

      <div class="grid">
        <input id="user" placeholder="Email do admin" autocomplete="username">
        <input id="pass" type="password" placeholder="Senha" autocomplete="current-password">
        <div class="row" style="align-items:center">
          <button class="btn" id="btnLogin">Entrar</button>
          <div class="pill" id="lockInfo" style="display:none">‚è≥ Bloqueado temporariamente</div>
          <div class="right error" id="msg"></div>
        </div>
      </div>

      <div class="muted" style="margin-top:8px; font-size:12px">
        Dica: o acesso agora √© pelo Firebase Auth (n√£o fica senha exposta no c√≥digo).
      </div>
    </div>

    <!-- Dashboard -->
    <div class="wrap" id="dash" style="display:none">
      <div class="topbar">
        <a class="brand" href="index.html">
          <div class="sig"></div>
          <div class="name">Or√°culos de The Magician</div>
        </a>
        <div class="row">
          <button class="btn" id="btnExport">Exportar JSON</button>
          <button class="btn" id="btnPublish">Publicar no site</button>
          <button class="btn" id="btnLogout">Sair</button>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="sobre">Sobre mim</div>
        <div class="tab" data-tab="consultas">Consultas & Or√°culos</div>
        <div class="tab" data-tab="feiticos">Feiti√ßos & Ritual√≠stica</div>
        <div class="tab" data-tab="depo">Depoimentos (imagens)</div>
        <div class="tab" data-tab="agenda">Agenda coletiva</div>
        <div class="tab" data-tab="cupons">Cupons & Promo</div>
      </div>

      <!-- Sobre mim -->
      <section class="section active" id="sobre">
        <div class="card">
          <h2>Texto ‚ÄúSobre mim‚Äù</h2>
          <textarea id="sobreTxt" placeholder="Escreva aqui..."></textarea>
          <div style="margin-top:10px"><button class="btn" data-save="sobre">Salvar</button></div>
        </div>
      </section>

      <!-- Consultas -->
      <section class="section" id="consultas">
        <div class="card">
          <h2>Cards de Consultas</h2>
          <div class="grid grid-3" id="listaConsultas"></div>
          <div class="divider" style="height:10px"></div>
          <div class="grid grid-3">
            <input id="c_titulo" placeholder="T√≠tulo (ex.: 1 Pergunta)">
            <input id="c_desc" placeholder="Descri√ß√£o curta">
            <input id="c_preco" placeholder="Pre√ßo (ex.: R$ 12)">
          </div>
          <div style="margin-top:10px"><button class="btn" id="addConsulta">Adicionar card</button></div>
        </div>
      </section>

      <!-- Feiti√ßos -->
      <section class="section" id="feiticos">
        <div class="card">
          <h2>Cards de Feiti√ßos</h2>
          <div class="grid grid-3" id="listaFeiticos"></div>
          <div class="divider" style="height:10px"></div>
          <div class="grid grid-3">
            <input id="f_titulo" placeholder="T√≠tulo (ex.: Equil√≠brio & Limpeza)">
            <input id="f_badge" placeholder="Badge (ex.: Cura)">
            <input id="f_desc" placeholder="Descri√ß√£o curta">
          </div>
          <div style="margin-top:10px"><button class="btn" id="addFeitico">Adicionar card</button></div>
        </div>
      </section>

      <!-- Depoimentos -->
      <section class="section" id="depo">
        <div class="card">
          <h2>Depoimentos por imagem</h2>
          <div id="listaDepo" class="grid grid-3"></div>
          <div class="divider" style="height:10px"></div>
          <div class="grid grid-2">
            <input id="d_file" type="file" accept="image/*">
            <input id="d_alt" placeholder="Alt (descri√ß√£o da imagem)">
          </div>
          <div style="margin-top:10px"><button class="btn" id="addDepo">Adicionar imagem</button></div>
        </div>
      </section>

      <!-- Agenda -->
      <section class="section" id="agenda">
        <div class="card">
          <h2>Agenda coletiva (datas)</h2>
          <div id="listaAgenda" class="grid grid-3"></div>
          <div class="divider" style="height:10px"></div>
          <div class="grid grid-3">
            <input id="a_data" type="date">
            <input id="a_hora" type="time">
            <input id="a_obs" placeholder="Observa√ß√£o (opcional)">
          </div>
          <div style="margin-top:10px"><button class="btn" id="addAgenda">Adicionar data</button></div>
        </div>
      </section>

      <!-- Cupons -->
      <section class="section" id="cupons">
        <div class="card">

          <!-- Promo edit√°vel -->
          <div class="card" style="margin-bottom:12px">
            <h2>T√≠tulo da Promo (aparece no site)</h2>
            <div class="grid grid-2">
              <input id="promo_titulo" placeholder="T√≠tulo (ex.: ü•§ M√™s da Coca-Cola)" />
              <input id="promo_subtitulo" placeholder="Subt√≠tulo (ex.: Cupom exclusivo do story)" />
            </div>
            <div style="margin-top:10px">
              <button class="btn" id="savePromo">Salvar t√≠tulo da promo</button>
            </div>
          </div>

          <h2>Cupons & Promo√ß√µes</h2>
          <div id="listaCupons" class="grid grid-3"></div>
          <div class="divider" style="height:10px"></div>
          <div class="grid grid-3">
            <input id="p_codigo" placeholder="C√≥digo (ex.: ROSADOURADA)">
            <input id="p_desc" placeholder="Descri√ß√£o (ex.: 15% OFF 3 Perguntas)">
            <input id="p_ativo" placeholder="Ativo? (true/false)">
          </div>
          <div style="margin-top:10px"><button class="btn" id="addCupom">Criar/atualizar cupom</button></div>
        </div>
      </section>
    </div>
  </div>

  <!-- ===== FIREBASE (compat) ===== -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // ===== CONFIG FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyDQA4AVdZu6TNi3eobf6qWaee0Hj-zujqg",
      authDomain: "oraculos-magician.firebaseapp.com",
      projectId: "oraculos-magician",
      storageBucket: "oraculos-magician.firebasestorage.app",
      messagingSenderId: "902773742288",
      appId: "1:902773742288:web:456563b2b37bc3ba19dcd5",
      measurementId: "G-7XG7N1Q7B9"
    };

    try { firebase.initializeApp(firebaseConfig); } catch (e) { }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== UI helpers =====
    const loginCard = document.getElementById('login-card');
    const dash = document.getElementById('dash');
    const msg = document.getElementById('msg');
    const lockInfo = document.getElementById('lockInfo');

    function showDash() {
      document.getElementById('app').classList.remove('center');
      loginCard.style.display = 'none';
      dash.style.display = 'block';
    }
    function showLogin() {
      document.getElementById('app').classList.add('center');
      dash.style.display = 'none';
      loginCard.style.display = 'block';
    }

    // ===== lock anti-bruteforce (local) =====
    const MAX_TRY = 5;
    const LOCK_MIN = 5;

    function setLock() { localStorage.setItem("adm_lock_until", Date.now() + LOCK_MIN * 60 * 1000); }
    function isLocked() {
      const until = parseInt(localStorage.getItem("adm_lock_until") || "0", 10);
      if (!until) return false;
      if (Date.now() >= until) { localStorage.removeItem("adm_lock_until"); return false; }
      return true;
    }
    function tries(n) { if (n !== undefined) localStorage.setItem("adm_tries", String(n)); return parseInt(localStorage.getItem("adm_tries") || "0", 10); }
    function updateLockUI() { lockInfo.style.display = isLocked() ? 'inline-flex' : 'none'; }

    // ===== auth guard =====
    showLogin();
    updateLockUI();
    auth.onAuthStateChanged((user) => {
      if (user) showDash();
      else showLogin();
    });

    // ===== login/logout =====
    document.getElementById('btnLogin').addEventListener('click', doLogin);
    document.getElementById('pass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

    async function doLogin() {
      if (isLocked()) { updateLockUI(); msg.textContent = "Bloqueado. Aguarde alguns minutos."; return; }

      try {
        const email = (document.getElementById('user').value || '').trim();
        const senha = document.getElementById('pass').value || '';
        msg.textContent = '';

        await auth.signInWithEmailAndPassword(email, senha);

        tries(0);
        msg.textContent = '';
      } catch (e) {
        const t = tries() + 1; tries(t);
        if (t >= MAX_TRY) { setLock(); updateLockUI(); }
        msg.textContent = "Email ou senha inv√°lidos.";
        console.error("Login error:", e);
      }
    }

    document.getElementById('btnLogout').addEventListener('click', async () => {
      try { await auth.signOut(); } catch (e) { }
      msg.textContent = '';
      showLogin();
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        el.classList.add('active');
        document.getElementById(el.dataset.tab).classList.add('active');
      });
    });

    // ===== STATE no admin (cache local p/ rascunho) =====
    const KEY = "admin_content_v1";
    const state = load() || {
      sobre: "", consultas: [], feiticos: [], depo: [], agenda: [], cupons: [],
      promo: { titulo: "", subtitulo: "" }
    };
    if (!state.promo) state.promo = { titulo: "", subtitulo: "" };

    function save() { localStorage.setItem(KEY, JSON.stringify(state)); }
    function load() { try { return JSON.parse(localStorage.getItem(KEY) || ""); } catch { return null; } }
// ===== PROMO (t√≠tulo/subt√≠tulo que aparece no site) =====
const promoTituloEl = document.getElementById('promo_titulo');
const promoSubtituloEl = document.getElementById('promo_subtitulo');
const btnSavePromo = document.getElementById('savePromo');

// preencher inputs ao abrir
if (promoTituloEl) promoTituloEl.value = state.promo?.titulo || "";
if (promoSubtituloEl) promoSubtituloEl.value = state.promo?.subtitulo || "";

// salvar no state
if (btnSavePromo) {
  btnSavePromo.addEventListener('click', () => {
    state.promo.titulo = (promoTituloEl?.value || '').trim();
    state.promo.subtitulo = (promoSubtituloEl?.value || '').trim();
    save();
    alert("T√≠tulo/Subt√≠tulo da promo salvos! Agora clique em 'Publicar no site'.");
  });
}

    // ===== Promo t√≠tulo/subt√≠tulo =====
    const promoTitulo = document.getElementById('promo_titulo');
    const promoSubtitulo = document.getElementById('promo_subtitulo');
    if (promoTitulo) promoTitulo.value = state.promo?.titulo || "";
    if (promoSubtitulo) promoSubtitulo.value = state.promo?.subtitulo || "";

    document.getElementById('savePromo')?.addEventListener('click', () => {
      state.promo.titulo = (promoTitulo?.value || "").trim();
      state.promo.subtitulo = (promoSubtitulo?.value || "").trim();
      save();
      alert("T√≠tulo da promo salvo!");
    });

    // Sobre
    const sobreTxt = document.getElementById('sobreTxt');
    sobreTxt.value = state.sobre || "";
    document.querySelector('[data-save="sobre"]').addEventListener('click', () => {
      state.sobre = sobreTxt.value; save(); alert('Salvo!');
    });

    // Consultas
    const elLC = document.getElementById('listaConsultas');
    function renderConsultas() {
      elLC.innerHTML = state.consultas.map((c, i) => `
        <div class="card">
          <strong>${c.titulo || '-'}</strong>
          <div class="muted">${c.desc || ''}</div>
          <div>${c.preco || ''}</div>
          <div style="margin-top:8px"><button class="btn" data-delc="${i}">Remover</button></div>
        </div>`).join('');
      elLC.querySelectorAll('[data-delc]').forEach(b => b.onclick = () => {
        state.consultas.splice(parseInt(b.dataset.delc, 10), 1); save(); renderConsultas();
      });
    }
    renderConsultas();
    document.getElementById('addConsulta').addEventListener('click', () => {
      const t = document.getElementById('c_titulo').value.trim();
      const d = document.getElementById('c_desc').value.trim();
      const p = document.getElementById('c_preco').value.trim();
      if (!t) return alert('Informe ao menos o t√≠tulo.');
      state.consultas.push({ titulo: t, desc: d, preco: p });
      save(); renderConsultas();
      ['c_titulo', 'c_desc', 'c_preco'].forEach(id => document.getElementById(id).value = "");
    });

    // Feiti√ßos
    const elLF = document.getElementById('listaFeiticos');
    function renderFeiticos() {
      elLF.innerHTML = state.feiticos.map((f, i) => `
        <div class="card">
          <span class="muted">${f.badge || ''}</span>
          <strong style="display:block">${f.titulo || '-'}</strong>
          <div class="muted">${f.desc || ''}</div>
          <div style="margin-top:8px"><button class="btn" data-delf="${i}">Remover</button></div>
        </div>`).join('');
      elLF.querySelectorAll('[data-delf]').forEach(b => b.onclick = () => {
        state.feiticos.splice(parseInt(b.dataset.delf, 10), 1); save(); renderFeiticos();
      });
    }
    renderFeiticos();
    document.getElementById('addFeitico').addEventListener('click', () => {
      const t = document.getElementById('f_titulo').value.trim();
      const b = document.getElementById('f_badge').value.trim();
      const d = document.getElementById('f_desc').value.trim();
      if (!t) return alert('Informe ao menos o t√≠tulo.');
      state.feiticos.push({ titulo: t, badge: b, desc: d });
      save(); renderFeiticos();
      ['f_titulo', 'f_badge', 'f_desc'].forEach(id => document.getElementById(id).value = "");
    });

    // Depoimentos (upload -> base64)
    const elLD = document.getElementById('listaDepo');
    function renderDepo() {
      elLD.innerHTML = state.depo.map((d, i) => `
        <div class="card">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <img src="${d.url}" alt="${(d.alt || '')}" style="max-width:120px; max-height:120px; border-radius:8px; border:1px solid rgba(255,255,255,.15)">
            <div>
              <div class="muted" style="word-break:break-all; max-width:420px">${(d.alt || '').replace(/</g, '&lt;')}</div>
              <div style="margin-top:8px"><button class="btn" data-deld="${i}">Remover</button></div>
            </div>
          </div>
        </div>`).join('');
      elLD.querySelectorAll('[data-deld]').forEach(b => b.onclick = () => {
        state.depo.splice(parseInt(b.dataset.deld, 10), 1); save(); renderDepo();
      });
    }
    renderDepo();
    document.getElementById('addDepo').addEventListener('click', () => {
      const file = document.getElementById('d_file').files?.[0];
      const alt = (document.getElementById('d_alt').value || '').trim();
      if (!file) return alert('Selecione uma imagem.');
      const reader = new FileReader();
      reader.onload = () => {
        state.depo.push({ url: reader.result, alt }); save(); renderDepo();
        document.getElementById('d_file').value = "";
        document.getElementById('d_alt').value = "";
      };
      reader.onerror = () => alert('Erro ao ler a imagem.');
      reader.readAsDataURL(file);
    });

    // Agenda
    const elLA = document.getElementById('listaAgenda');
    function renderAgenda() {
      elLA.innerHTML = state.agenda.map((a, i) => `
        <div class="card">
          <strong>${a.data || ''} ${a.hora || ''}</strong>
          <div class="muted">${a.obs || ''}</div>
          <div style="margin-top:8px"><button class="btn" data-dela="${i}">Remover</button></div>
        </div>`).join('');
      elLA.querySelectorAll('[data-dela]').forEach(b => b.onclick = () => {
        state.agenda.splice(parseInt(b.dataset.dela, 10), 1); save(); renderAgenda();
      });
    }
    renderAgenda();
    document.getElementById('addAgenda').addEventListener('click', () => {
      const data = document.getElementById('a_data').value;
      const hora = document.getElementById('a_hora').value;
      const obs = document.getElementById('a_obs').value.trim();
      if (!data) return alert('Informe a data.');
      state.agenda.push({ data, hora, obs });
      save(); renderAgenda();
      ['a_data', 'a_hora', 'a_obs'].forEach(id => document.getElementById(id).value = "");
    });

    // Cupons
    const elLP = document.getElementById('listaCupons');
    function renderCupons() {
      elLP.innerHTML = state.cupons.map((c, i) => `
        <div class="card">
          <strong>${c.codigo}</strong> ‚Äî <span class="muted">${c.desc || ''}</span> ‚Äî ativo: <b>${!!c.ativo}</b>
          <div style="margin-top:8px"><button class="btn" data-delp="${i}">Remover</button></div>
        </div>`).join('');
      elLP.querySelectorAll('[data-delp]').forEach(b => b.onclick = () => {
        state.cupons.splice(parseInt(b.dataset.delp, 10), 1); save(); renderCupons();
      });
    }
    renderCupons();

    document.getElementById('addCupom').addEventListener('click', () => {
      const codigo = (document.getElementById('p_codigo').value || "").trim().toUpperCase(); // ‚úÖ MAI√öSCULO
      const desc = (document.getElementById('p_desc').value || "").trim();
      const ativo = ((document.getElementById('p_ativo').value || "false").trim().toLowerCase() === 'true');

      if (!codigo) return alert('Informe o c√≥digo.');

      const i = state.cupons.findIndex(c => (c.codigo || "").toUpperCase() === codigo);
      const obj = { codigo, desc, ativo };

      if (i >= 0) state.cupons[i] = obj;
      else state.cupons.push(obj);

      save(); renderCupons();
      ['p_codigo', 'p_desc', 'p_ativo'].forEach(id => document.getElementById(id).value = "");
    });

    // Export JSON
    document.getElementById('btnExport').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'conteudo-site.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Monta pacote oficial p/ publicar
    function montarPacote() {
      return {
        about: state.sobre || "",

        // ‚úÖ promo edit√°vel no site
        promo: {
          titulo: state.promo?.titulo || "",
          subtitulo: state.promo?.subtitulo || ""
        },

        consultas: (state.consultas || []).map(c => ({
          titulo: c.titulo || "", desc: c.desc || "", preco: c.preco || "", badge: c.badge || ""
        })),
        feiticos: (state.feiticos || []).map(f => ({
          titulo: f.titulo || "", desc: f.desc || "", badge: f.badge || ""
        })),
        depoimentos: (state.depo || []).map(d => ({ img: d.url || "", alt: d.alt || "" })),
        agenda: (state.agenda || []).map(a => {
          const iso = (a.data ? `${a.data}T${a.hora || "23:59"}` : "").trim();
          const d = iso ? new Date(iso) : null;
          return d && !isNaN(d) ? { date: d.toISOString(), obs: a.obs || "" } : null;
        }).filter(Boolean),

        // ‚úÖ cupons pro site
        cupons: (state.cupons || []).map(c => ({
          codigo: (c.codigo || "").toUpperCase(),
          desconto: c.desc || "",
          ativo: !!c.ativo
        }))
      };
    }

    async function salvarAdmin() {
      if (!auth.currentUser) {
        alert("Voc√™ precisa estar logada para publicar.");
        return;
      }

      try {
        const data = montarPacote();
        localStorage.setItem('tm_data', JSON.stringify(data)); // preview local
        await db.collection("siteData").doc("conteudo").set(data); // oficial
        alert("Publicado com sucesso!");
      } catch (e) {
        console.error("Erro ao salvar:", e);
        alert("Erro ao publicar no Firebase (verifique Regras do Firestore).");
      }
    }

    document.getElementById('btnPublish').addEventListener('click', async () => {
      await salvarAdmin();
      localStorage.setItem('tm_ping', Date.now().toString());
    });

    // Salvar local e pingar site quando clica no t√≠tulo
    (function () {
      const els = [document.getElementById('brandHomeDash')].filter(Boolean);
      els.forEach((el) => {
        el.addEventListener('click', function () {
          try { salvarAdmin(); } catch (e) { }
          localStorage.setItem('tm_ping', Date.now().toString());
        });
      });
    })();

  </script>

</body>

</html>
